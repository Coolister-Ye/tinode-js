!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Tinode=e()}}(function(){var e=[{name:"ST",start:/(?:^|\W)(\*)[^\s*]/,end:/[^\s*](\*)(?=$|\W)/},{name:"EM",start:/(?:^|[\W_])(_)[^\s_]/,end:/[^\s_](_)(?=$|[\W_])/},{name:"DL",start:/(?:^|\W)(~)[^\s~]/,end:/[^\s~](~)(?=$|\W)/},{name:"CO",start:/(?:^|\W)(`)[^`]/,end:/[^`](`)(?=$|\W)/}],t=[{name:"LN",dataName:"url",pack:function(e){return/^[a-z]+:\/\//i.test(e)||(e="http://"+e),{url:e}},re:/(https?:\/\/)?(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,4}\b(?:[-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)/g},{name:"MN",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B@(\w\w+)/g},{name:"HT",dataName:"val",pack:function(e){return{val:e.slice(1)}},re:/\B#(\w\w+)/g}],n={ST:{name:"b",isVoid:!1},EM:{name:"i",isVoid:!1},DL:{name:"del",isVoid:!1},CO:{name:"tt",isVoid:!1},BR:{name:"br",isVoid:!0},LN:{name:"a",isVoid:!1},MN:{name:"a",isVoid:!1},HT:{name:"a",isVoid:!1},IM:{name:"img",isVoid:!0}};function s(e,t){var n;try{n=atob(e)}catch(e){console.log("Drafty: failed to decode base64-encoded object",e.message),n=atob("")}for(var s=n.length,r=new ArrayBuffer(s),i=new Uint8Array(r),a=0;a<s;a++)i[a]=n.charCodeAt(a);return URL.createObjectURL(new Blob([r],{type:t}))}var r={ST:{open:function(){return"<b>"},close:function(){return"</b>"}},EM:{open:function(){return"<i>"},close:function(){return"</i>"}},DL:{open:function(){return"<del>"},close:function(){return"</del>"}},CO:{open:function(){return"<tt>"},close:function(){return"</tt>"}},BR:{open:function(){return""},close:function(){return"<br/>"}},LN:{open:function(e){return'<a href="'+e.url+'">'},close:function(e){return"</a>"},props:function(e){return{href:e.url,target:"_blank"}}},MN:{open:function(e){return'<a href="#'+e.val+'">'},close:function(e){return"</a>"},props:function(e){return{name:e.val}}},HT:{open:function(e){return'<a href="#'+e.val+'">'},close:function(e){return"</a>"},props:function(e){return{name:e.val}}},IM:{open:function(e){var t=s(e.val,e.mime),n=e.ref?e.ref:t,r=(e.name?'<a href="'+n+'" download="'+e.name+'">':"")+'<img src="'+t+'"'+(e.width?' width="'+e.width+'"':"")+(e.height?' height="'+e.height+'"':"")+' border="0" />';return console.log("open: "+r),r},close:function(e){return e.name?"</a>":""},props:function(e){return{src:s(e.val,e.mime),title:e.name,"data-width":e.width,"data-height":e.height,"data-name":e.name,"data-size":.75*e.val.length|0,"data-mime":e.mime}}}},i={parse:function(n){if("string"!=typeof n)return null;var s=n.split(/\r?\n/),r=[],i={},a=[];s.map(function(n){var s,o,c=[];if(e.map(function(e){c=c.concat(function(e,t,n,s){for(var r=[],i=0,a=e.slice(0);a.length>0;){var o=t.exec(a);if(null==o)break;var c=o.index+o[0].lastIndexOf(o[1]);a=a.slice(c+1),i=(c+=i)+1;var u=n?n.exec(a):null;if(null==u)break;var l=u.index+u[0].indexOf(u[1]);a=a.slice(l+1),i=(l+=i)+1,r.push({text:e.slice(c+1,l),children:[],start:c,end:l,type:s})}return r}(n,e.start,e.end,e.name))}),0==c.length)o={txt:n};else{c.sort(function(e,t){return e.start-t.start}),c=function e(t){if(0==t.length)return[];for(var n=[t[0]],s=t[0],r=1;r<t.length;r++)t[r].start>s.end?(n.push(t[r]),s=t[r]):t[r].end<s.end&&s.children.push(t[r]);for(var r in n)n[r].children=e(n[r].children);return n}(c);var u=function e(t,n){var s="",r=[];for(var i in t){var a=t[i];if(!a.text){var o=e(a.children,s.length+n);a.text=o.txt,r=r.concat(o.fmt)}a.type&&r.push({at:s.length+n,len:a.text.length,tp:a.type}),s+=a.text}return{txt:s,fmt:r}}(function e(t,n,s,r){var i=[];if(0==r.length)return[];for(var a in r){var o=r[a];o.start>n&&i.push({text:t.slice(n,o.start)});var c={type:o.type},u=e(t,o.start+1,o.end-1,o.children);u.length>0?c.children=u:c.text=o.text,i.push(c),n=o.end+1}return n<s&&i.push({text:t.slice(n,s)}),i}(n,0,n.length,c),0);o={txt:u.txt,fmt:u.fmt}}if((s=function(e){var n,s=[];if(t.map(function(t){for(;null!==(n=t.re.exec(e));)s.push({offset:n.index,len:n[0].length,unique:n[0],data:t.pack(n[0]),type:t.name})}),0==s.length)return s;s.sort(function(e,t){return e.offset-t.offset});var r=-1;return s=s.filter(function(e){var t=e.offset>r;return r=e.offset+e.len,t})}(o.txt)).length>0){var l=[];for(var h in s){var d=s[h],f=i[d.unique];f||(f=r.length,i[d.unique]=f,r.push({tp:d.type,data:d.data})),l.push({at:d.offset,len:d.len,key:f})}o.ent=l}a.push(o)});var o={txt:""};if(a.length>0){o.txt=a[0].txt,o.fmt=(a[0].fmt||[]).concat(a[0].ent||[]);for(var c=1;c<a.length;c++){var u=a[c],l=o.txt.length+1;o.fmt.push({tp:"BR",len:1,at:l-1}),o.txt+=" "+u.txt,u.fmt&&(o.fmt=o.fmt.concat(u.fmt.map(function(e){return e.at+=l,e}))),u.ent&&(o.fmt=o.fmt.concat(u.ent.map(function(e){return e.at+=l,e})))}0==o.fmt.length&&delete o.fmt,r.length>0&&(o.ent=r)}return o},insertImage:function(e,t,n,s,r,i,a,o,c){return(e=e||{txt:" "}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:t,len:1,key:e.ent.length}),e.ent.push({tp:"IM",data:{mime:n,val:s,width:r,height:i,name:a,ref:c,size:0|o}}),e},attachFile:function(e,t,n,s,r,i){(e=e||{txt:""}).ent=e.ent||[],e.fmt=e.fmt||[],e.fmt.push({at:-1,len:0,key:e.ent.length});var a={tp:"EX",data:{mime:t,val:n,name:s,ref:i,size:0|r}};return i instanceof Promise&&i.then(function(e){a.data.ref=e},function(e){}),e.ent.push(a),e},UNSAFE_toHTML:function(e){var t,n,s,i=e.txt,a=e.fmt,o=e.ent,c=[];if(a)for(var u in a){var l,h=a[u],d=h.tp;if(!d){var f=o[h.key];f&&(d=f.tp,l=f.data)}r[d]&&(c.push({idx:h.at+h.len,what:r[d].close(l)}),c.push({idx:h.at,what:r[d].open(l)}))}for(var u in c.sort(function(e,t){return t.idx-e.idx}),c)c[u].what&&(t=i,n=c[u].idx,s=c[u].what,i=t.slice(0,n)+s+t.slice(n));return i},format:function(e,t,s){var r=e.txt,i=e.fmt,a=e.ent;if(r=r||"",!i)return[r];var o=[].concat(i);return o.map(function(e){e.at=e.at||0,e.len=e.len||0}),o.sort(function(e,t){return e.at-t.at==0?t.len-e.len:e.at-t.at}),o=o.map(function(e){var t,n=e.tp;return n||(e.key=e.key||0,t=a[e.key].data,n=a[e.key].tp),{tp:n,data:t,at:e.at,len:e.len}}),function e(t,s,r,i,a,o){for(var c=[],u=0;u<i.length;u++){var l=i[u];s<l.at&&(c.push(a.call(o,null,void 0,t.slice(s,l.at))),s=l.at);for(var h=[],d=u+1;d<i.length&&i[d].at<l.at+l.len;d++)h.push(i[d]),u=d;var f=n[l.tp]||{};c.push(a.call(o,l.tp,l.data,f.isVoid?null:e(t,s,l.at+l.len,h,a,o))),s=l.at+l.len}return s<r&&c.push(a.call(o,null,void 0,t.slice(s,r))),c}(r,0,r.length,o,t,s)},toPlainText:function(e){return e.txt},isPlainText:function(e){return!(e.fmt||e.ent)},hasAttachments:function(e){if(e.ent&&e.ent.length>0)for(var t in e.ent)if("EX"==e.ent[t].tp)return!0;return!1},attachments:function(e,t,n){if(e.ent&&e.ent.length>0)for(var s in e.ent)"EX"==e.ent[s].tp&&t.call(n,e.ent[s].data,s)},getDownloadUrl:function(e){var t=null;return e.val?t=s(e.val,e.mime):"string"==typeof e.ref&&(t=e.ref),t},isUploading:function(e){return e.ref instanceof Promise},getPreviewUrl:function(e){return e.val?s(e.val,e.mime):null},getEntitySize:function(e){return e.size?e.size:e.val?.75*e.val.length|0:0},getEntityMimeType:function(e){return e.mime||"text/plain"},tagName:function(e){return n[e]?n[e].name:void 0},attrValue:function(e,t){if(t&&r[e])return r[e].props(t)},getContentType:function(){return"text/x-drafty"}},a={};function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var c="0",u="0.15",l="tinodejs/"+u,h="new",d="me",f="fnd",p="new",g=268435455,v=0,m=1,b=2,_=3,w=4,M=5,S=6;function y(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}))}function D(e,t,n){if(null==t)return e;if("object"!==o(t))return t||e;if(t instanceof Date)return t;if(t instanceof P)return new P(t);if(t instanceof Array)return t.length>0?t:e;for(var s in e||(e=t.constructor()),t)!t.hasOwnProperty(s)||!t[s]&&!1!==t[s]||n&&n[s]||"_generated"==s||(e[s]=D(e[s],t[s]));return e}function T(e,t,n,s){return e[t]=D(e[t],n,s),e[t]}function x(){var e=null;if("withCredentials"in new XMLHttpRequest)e=new XMLHttpRequest;else{if("undefined"==typeof XDomainRequest)throw new Error("browser not supported");e=new XDomainRequest}return e}function E(e,t){if("ts"===e&&"string"==typeof t&&t.length>=20&&t.length<=24){var n=new Date(t);if(n)return n}else if("acs"===e&&"object"===o(t))return new P(t);return t}function R(e,t){return"string"==typeof t&&t.length>128?"<"+t.length+", bytes: "+t.substring(0,12)+"..."+t.substring(t.length-12)+">":function(e,t){if(t instanceof Date)t=function(e){if(e&&0!=e.getTime()){var t=e.getUTCMilliseconds();return e.getUTCFullYear()+"-"+n(e.getUTCMonth()+1)+"-"+n(e.getUTCDate())+"T"+n(e.getUTCHours())+":"+n(e.getUTCMinutes())+":"+n(e.getUTCSeconds())+(t?"."+n(t,3):"")+"Z"}function n(e,t){return"0".repeat((t=t||2)-(""+e).length)+e}}(t);else if(null==t||!1===t||Array.isArray(t)&&0==t.length||"object"===o(t)&&0===Object.keys(t).length)return;return t}(0,t)}function A(e,t,n){var s=null;return"http"!==t&&"https"!==t&&"ws"!==t&&"wss"!==t||(s=t+"://","/"!==(s+=e).charAt(s.length-1)&&(s+="/"),s+="v"+c+"/channels","http"!==t&&"https"!==t||(s+="/lp"),s+="?apikey="+n),s}var U=function(e,t){var n,s,r,i,a=t,o=2e3,c=10,u=.3,l=null,h=0,d=!1;function f(e){n.logger&&n.logger(e)}function p(){var e=null;return{connect:function(t){return e&&1===e.readyState?Promise.resolve():(t&&(s=t),new Promise(function(t,p){var g=A(s,r?"wss":"ws",i);f("Connecting to: "+g);var v=new WebSocket(g);v.onopen=function(e){d=!1,n.onOpen&&n.onOpen(),t(),a&&(window.clearTimeout(l),l=null,h=0)},v.onclose=function(t){e=null,n.onDisconnect&&n.onDisconnect(null),!d&&a&&function(){window.clearTimeout(l);var e=o*(Math.pow(2,h)*(1+u*Math.random()));h=h>=c?h:h+1,l=setTimeout(function(){console.log("Reconnecting, iter="+h+", timeout="+e),d||n.connect().catch(function(){})},e)}()},v.onerror=function(e){p(e)},v.onmessage=function(e){n.onMessage&&n.onMessage(e.data)},e=v}))},disconnect:function(){e&&(d=!0,e.close()),e=null},sendText:function(t){if(!e||e.readyState!=e.OPEN)throw new Error("Websocket is not connected");e.send(t)},isConnected:function(){return e&&1===e.readyState}}}function g(){var e=null,t=null,a=null;return{connect:function(a){return a&&(s=a),new Promise(function(a,o){var c=A(s,r?"https":"http",i);f("Connecting to: "+c),(t=function t(s,r,i){var a=x();return a.onreadystatechange=function(o){if(4==a.readyState)if(201==a.status){var c=JSON.parse(a.responseText,E);a.responseText,e=s+"&sid="+c.ctrl.params.sid,(a=t(e)).send(null),n.onOpen&&n.onOpen(),r&&r()}else 200==a.status?(n.onMessage&&n.onMessage(a.responseText),(a=t(e)).send(null)):(i&&i(a.responseText),n.onMessage&&n.onMessage(a.responseText),n.onDisconnect&&n.onDisconnect(new Error(a.status+" "+a.responseText)))},a.open("GET",s,!0),a}(c,a,o)).send(null)}).catch(function(){})},disconnect:function(){a&&(a.abort(),a=null),t&&(t.abort(),t=null),n.onDisconnect&&n.onDisconnect(null),e=null},sendText:function(t){var n,s;if(n=e,(s=x()).onreadystatechange=function(e){if(4==s.readyState&&s.status>=400)throw new Error("LP sender failed, "+s.status)},s.open("POST",n,!0),!(a=s)||1!=a.readyState)throw new Error("Long poller failed to connect");a.send(t)},isConnected:function(){return t&&!0}}}return(n="lp"===e?g():"ws"===e?p():window.WebSocket?p():g()).setup=function(e,t,n){s=e,r=t,i=n},n.onMessage=void 0,n.onDisconnect=void 0,n.onOpen=void 0,n.logger=void 0,n},I=function(){var e;return{getInstance:function(){return e||(e=function(){var t="Undefined",n="undefined",s="";"undefined"!=typeof navigator&&(s=function(e){var t,n=(e=(e||"").replace(" (KHTML, like Gecko)","")).match(/(AppleWebKit\/[.\d]+)/i);if(n){for(var s=["chrome","safari","mobile","version"],r=e.substr(n.index+n[0].length).split(" "),i=[],a=0;a<r.length;a++){var o=/([\w.]+)[\/]([\.\d]+)/.exec(r[a]);o&&i.push([o[1],o[2],s.findIndex(function(e){return e==o[1].toLowerCase()})])}i.sort(function(e,t){var n=e[2]-t[2];return 0!=n?n:t[0].length-e[0].length}),t=i.length>0?i[0][0]+"/"+i[0][1]:n[1]}else t=/trident/i.test(e)?(n=/(?:\brv[ :]+([.\d]+))|(?:\bMSIE ([.\d]+))/g.exec(e))?"MSIE/"+(n[1]||n[2]):"MSIE/?":/firefox/i.test(e)?(n=/Firefox\/([.\d]+)/g.exec(e))?"Firefox/"+n[1]:"Firefox/?":/presto/i.test(e)?(n=/Opera\/([.\d]+)/g.exec(e))?"Opera/"+n[1]:"Opera/?":(n=/([\w.]+)\/([.\d]+)/.exec(e))?n[1]+"/"+n[2]:(n=e.split(" "))[0];if((n=t.split("/")).length>1){var c=n[1].split(".");t=n[0]+"/"+c[0]+(c[1]?"."+c[1]:"")}return t}(navigator.userAgent),n=navigator.platform);var r=!1,i=!1,a=null,c=null,T=null,x=!1,A=null,I=null,O=0,P=null,j={},L={};function W(e){if(r){var t=new Date,n=("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)+":"+("0"+t.getUTCMilliseconds()).slice(-3);console.log("["+n+"] "+e)}}function F(e,t,n){j[e+":"+t]=n}function V(e,t){return j[e+":"+t]}function G(e,t){delete j[e+":"+t]}function H(e){e._cacheGetUser=function(e){var t=V("user",e);if(t)return{user:e,public:D({},t)}},e._cachePutUser=function(e,t){return F("user",e,D({},t.public))},e._cacheDelUser=function(e){return G("user",e)},e._cachePutSelf=function(){return F("topic",e.name,e)},e._cacheDelSelf=function(){return G("topic",e.name)}}var J=function(e){var t=null;return e&&(t=new Promise(function(t,n){L[e]={resolve:t,reject:n}})),t};function z(){return 0!=O?""+O++:void 0}function B(e,r){switch(e){case"hi":return{hi:{id:z(),ver:u,ua:t+" ("+(s?s+"; ":"")+n+"); "+l}};case"acc":return{acc:{id:z(),user:null,scheme:null,secret:null,login:!1,tags:null,desc:{},cred:{}}};case"login":return{login:{id:z(),scheme:null,secret:null}};case"sub":return{sub:{id:z(),topic:r,set:{},get:{}}};case"leave":return{leave:{id:z(),topic:r,unsub:!1}};case"pub":return{pub:{id:z(),topic:r,noecho:!1,head:null,content:{}}};case"get":return{get:{id:z(),topic:r,what:null,desc:{},sub:{},data:{}}};case"set":return{set:{id:z(),topic:r,desc:{},sub:{},tags:[]}};case"del":return{del:{id:z(),topic:r,what:null,delseq:null,user:null,hard:!1}};case"note":return{note:{topic:r,what:null,seq:void 0}};default:throw new Error("Unknown packet type requested: "+e)}}function K(e,t){var n;t&&(n=J(t)),e=function e(t){return Object.keys(t).forEach(function(n){"_"==n[0]?delete t[n]:t[n]?Array.isArray(t[n])&&0==t[n].length?delete t[n]:t[n]?"object"!=o(t[n])||t[n]instanceof Date||(e(t[n]),0==Object.getOwnPropertyNames(t[n]).length&&delete t[n]):delete t[n]:delete t[n]}),t}(e);var s=JSON.stringify(e);return W("out: "+(i?JSON.stringify(e,R):s)),a.sendText(s),n}function Q(t){if(t){e.onRawMessage&&e.onRawMessage(t);var n,s,r,a,o,c=JSON.parse(t,E);if(c)if(W("in: "+(i?JSON.stringify(c,R):t)),e.onMessage&&e.onMessage(c),c.ctrl)e.onCtrlMessage&&e.onCtrlMessage(c.ctrl),c.ctrl.id&&(n=c.ctrl.id,s=c.ctrl.code,r=c.ctrl,a=c.ctrl.text,(o=L[n])&&(delete L[n],s>=200&&s<400?o.resolve&&o.resolve(r):o.reject&&o.reject(new Error("Error: "+a+" ("+s+")"))));else if(c.meta)(u=V("topic",c.meta.topic))&&u._routeMeta(c.meta),e.onMetaMessage&&e.onMetaMessage(c.meta);else if(c.data)(u=V("topic",c.data.topic))&&u._routeData(c.data),e.onDataMessage&&e.onDataMessage(c.data);else if(c.pres)(u=V("topic",c.pres.topic))&&u._routePres(c.pres),e.onPresMessage&&e.onPresMessage(c.pres);else if(c.info){var u;(u=V("topic",c.info.topic))&&u._routeInfo(c.info),e.onInfoMessage&&e.onInfoMessage(c.info)}else W("ERROR: Unknown packet received.");else W("in: "+t),W("ERROR: failed to parse data")}}function X(){e.hello()}function $(t){P=null,x=!1,function(e,t){for(var n in j)if(s=j[n],void(0===n.lastIndexOf("topic:",0)&&s._resetSub()))break;var s}(),e.onDisconnect&&e.onDisconnect(t)}function Z(t){T=t.params.user,x=t&&t.code>=200&&t.code<300,I=t.params&&t.params.token&&t.params.expires?{token:t.params.token,expires:new Date(t.params.expires)}:null,e.onLogin&&e.onLogin(t.code,t.text)}return{setup:function(e,n,s,r,i){void 0===i&&(i=window.location&&"https:"===window.location.protocol),O=Math.floor(65535*Math.random()+65535),t=e||"Undefined",c=s,T=null,x=!1,A=null,I=null,P=null,j={},L={},a&&a.disconnect(),(a=U(r,!0)).logger=W,a.onMessage=Q,a.onDisconnect=$,a.onOpen=X,a.setup(n,i,s)},connect:function(e){return a.connect(e)},disconnect:function(){a&&a.disconnect()},isConnected:function(){return a&&a.isConnected()},isAuthenticated:function(){return x},account:function(e,t,n,s,r){var i=B("acc");return i.acc.user=e,i.acc.scheme=t,i.acc.secret=n,i.acc.login=s,r&&(i.acc.desc.defacs=r.defacs,i.acc.desc.public=r.public,i.acc.desc.private=r.private,i.acc.tags=r.tags,i.acc.cred=r.cred),K(i,i.acc.id)},createAccount:function(t,n,s,r){var i=e.account(p,t,n,s,r);return s&&(i=i.then(function(e){return Z(e),e})),i},createAccountBasic:function(t,n,s){return t=t||"",n=n||"",e.createAccount("basic",y(t+":"+n),!0,s)},updateAccountBasic:function(t,n,s){return n=n||"",s=s||"",e.account(t,"basic",y(n+":"+s),!1,null)},addCredential:function(e,t,n,s,r){if("object"==o(t)){var i=t;n=i.val,s=i.params,r=i.resp,t=i.meth}return t&&(n||r)&&(e||(e={}),e.cred||(e.cred=[]),e.cred.push({meth:t,val:n,resp:r,params:s})),e},hello:function(){var t=B("hi");return K(t,t.hi.id).then(function(t){return t.params&&(P=t.params),e.onConnect&&e.onConnect(),t}).catch(function(t){e.onDisconnect&&e.onDisconnect(t)})},login:function(e,t,n){var s=B("login");return s.login.scheme=e,s.login.secret=t,s.login.cred=n,K(s,s.login.id).then(function(e){return Z(e),e})},loginBasic:function(t,n,s){return e.login("basic",y(t+":"+n),s).then(function(e){return A=t,e})},loginToken:function(t,n){return e.login("token",t,n)},getAuthToken:function(){return I&&I.expires.getTime()>Date.now()?I:(I=null,null)},setAuthToken:function(e){I=e},subscribe:function(e,t,n){var s=B("sub",e);return e||(e=h),s.sub.get=t,n&&(n.sub&&(s.sub.set.sub=n.sub),e===h&&n.desc&&(s.sub.set.desc=n.desc),n.tags&&(s.sub.set.tags=n.tags)),K(s,s.sub.id)},leave:function(e,t){var n=B("leave",e);return n.leave.unsub=t,K(n,n.leave.id)},createMessage:function(e,t,n,s,r){var i=B("pub",e);return i.pub.noecho=n,i.pub.content=t,(s||Array.isArray(r))&&(i.pub.head={mime:s,attachments:r}),i.pub},publish:function(t,n,s,r,i){return e.publishMessage(e.createMessage(t,n,s,r,i))},publishMessage:function(e){return(e=Object.assign({},e)).seq=void 0,e.from=void 0,e.ts=void 0,K({pub:e},e.id)},getMeta:function(e,t){var n=B("get",e);return n.get=D(n.get,t),K(n,n.get.id)},setMeta:function(e,t){var n=B("set",e),s=[];return t&&["desc","sub","tags"].map(function(e){t.hasOwnProperty(e)&&(s.push(e),n.set[e]=t[e])}),0==s.length?Promise.reject(new Error("Invalid {set} parameters")):K(n,n.set.id)},delMessages:function(e,t,n){var s=B("del",e);return s.del.what="msg",s.del.delseq=t,s.del.hard=n,K(s,s.del.id)},delTopic:function(e){var t=B("del",e);return t.del.what="topic",K(t,t.del.id).then(function(t){return G("topic",e),t})},delSubscription:function(e,t){var n=B("del",e);return n.del.what="sub",n.del.user=t,K(n,n.del.id)},note:function(e,t,n){if(n<=0||n>=g)console.log("Invalid message id "+n);else{var s=B("note",e);s.note.what=t,s.note.seq=n,K(s)}},noteKeyPress:function(e){var t=B("note",e);t.note.what="kp",K(t)},getTopic:function(e){var t=V("topic",e);return!t&&e&&((t=e===d?new C:e===f?new N:new q(e))._new=!1,F("topic",e,t)),t&&H(t),t},newTopic:function(e){var t=new q(void 0,e);return H(t),t},newTopicWith:function(e,t){var n=new q(e,t);return H(n),n},getMeTopic:function(){return e.getTopic(d)},getFndTopic:function(){return e.getTopic(f)},getLargeFileHelper:function(){var t=e.getAuthToken();return t?new k(c,t.token,z()):null},getCurrentUserID:function(){return T},getCurrentLogin:function(){return A},getServerInfo:function(){return P},getVersion:function(){return u},enableLogging:function(e,t){r=e,i=t},topicType:function(e){return{me:"me",fnd:"fnd",grp:"grp",new:"grp",usr:"p2p"}["string"==typeof e?e.substring(0,3):"xxx"]},isTopicOnline:function(t){var n=e.getTopic(d),s=n&&n.getContact(t);return s&&s.online},wantAkn:function(e){O=e?Math.floor(16777215*Math.random()+16777215):0},onWebsocketOpen:void 0,onConnect:void 0,onDisconnect:void 0,onLogin:void 0,onCtrlMessage:void 0,onDataMessage:void 0,onPresMessage:void 0,onMessage:void 0,onRawMessage:void 0,MESSAGE_STATUS_NONE:v,MESSAGE_STATUS_QUEUED:m,MESSAGE_STATUS_SENDING:b,MESSAGE_STATUS_SENT:_,MESSAGE_STATUS_RECEIVED:w,MESSAGE_STATUS_READ:M,MESSAGE_STATUS_TO_ME:S}}()),e}}}(),O=function(e){this.topic=e,this.what={}};O.prototype={withData:function(e,t,n){return this.what.data={since:e,before:t,limit:n},this},withLaterData:function(e){return this.withData(this.topic._maxSeq>0?this.topic._maxSeq+1:void 0,void 0,e)},withEarlierData:function(e){return this.withData(void 0,this.topic._minSeq>0?this.topic._minSeq:void 0,e)},withDesc:function(e){return this.what.desc={ims:e},this},withLaterDesc:function(){return this.withDesc(this.topic._lastDescUpdate)},withSub:function(e,t,n){var s={ims:e,limit:t};return"me"==this.topic.getType()?s.topic=n:s.user=n,this.what.sub=s,this},withOneSub:function(e,t){return this.withSub(e,void 0,t)},withLaterOneSub:function(e){return this.withOneSub(this.topic._lastSubsUpdate,e)},withLaterSub:function(e){return this.withSub(this.topic._lastSubsUpdate,e)},withTags:function(){return this.what.tags=!0,this},withDel:function(e,t){return(e||t)&&(this.what.del={since:e,limit:t}),this},withLaterDel:function(e){return this.withDel(this.topic._maxSeq>0?this.topic._maxDel+1:void 0,e)},build:function(){var e={},t=[],n=this;return["data","sub","desc","tags","del"].map(function(s){n.what.hasOwnProperty(s)&&(t.push(s),Object.getOwnPropertyNames(n.what[s]).length>0&&(e[s]=n.what[s]))}),t.length>0?e.what=t.join(" "):e=void 0,e}};var P=function e(t){t&&(this.given="number"==typeof t.given?t.given:e.decode(t.given),this.want="number"==typeof t.want?t.want:e.decode(t.want),this.mode=t.mode?"number"==typeof t.mode?t.mode:e.decode(t.mode):this.given&this.want)};P._NONE=0,P._JOIN=1,P._READ=2,P._WRITE=4,P._PRES=8,P._APPROVE=16,P._SHARE=32,P._DELETE=64,P._OWNER=128,P._BITMASK=P._JOIN|P._READ|P._WRITE|P._PRES|P._APPROVE|P._SHARE|P._DELETE|P._OWNER,P._INVALID=1048576,P.decode=function(e){if(!e)return null;if("number"==typeof e)return e&P._BITMASK;if("N"===e||"n"===e)return P._NONE;for(var t={J:P._JOIN,R:P._READ,W:P._WRITE,P:P._PRES,A:P._APPROVE,S:P._SHARE,D:P._DELETE,O:P._OWNER},n=P._NONE,s=0;s<e.length;s++){var r=t[e.charAt(s).toUpperCase()];r&&(n|=r)}return n},P.encode=function(e){if(null===e||e===P._INVALID)return null;if(e===P._NONE)return"N";for(var t=["J","R","W","P","A","S","D","O"],n="",s=0;s<t.length;s++)0!=(e&1<<s)&&(n+=t[s]);return n},P.update=function(e,t){if(!t||"string"!=typeof t)return e;var n=t.charAt(0);if("+"==n||"-"==n){for(var s=e,r=t.split(/([-+])/),i=1;i<r.length-1;i+=2){n=r[i];var a=P.decode(r[i+1]);if(a==P._INVALID)return e;null!=a&&("+"===n?s|=a:"-"===n&&(s&=~a))}e=s}else(s=P.decode(t))!=P._INVALID&&(e=s);return e},P.prototype={setMode:function(e){return this.mode=P.decode(e),this},updateMode:function(e){return this.mode=P.update(this.mode,e),this},getMode:function(){return P.encode(this.mode)},setGiven:function(e){return this.given=P.decode(e),this},updateGiven:function(e){return this.given=P.update(this.given,e),this},getGiven:function(){return P.encode(this.given)},setWant:function(e){return this.want=P.decode(e),this},updateWant:function(e){return this.want=P.update(this.want,e),this},getWant:function(){return P.encode(this.want)},updateAll:function(e){return e&&(this.updateGiven(e.given),this.updateWant(e.want),this.mode=this.given&this.want),this},isOwner:function(){return 0!=(this.mode&P._OWNER)},isMuted:function(){return 0==(this.mode&P._PRES)},isPresencer:function(){return 0!=(this.mode&P._PRES)},isJoiner:function(){return 0!=(this.mode&P._JOIN)},isReader:function(){return 0!=(this.mode&P._READ)},isWriter:function(){return 0!=(this.mode&P._WRITE)},isApprover:function(){return 0!=(this.mode&P._APPROVE)},isAdmin:function(){return this.isOwner()||this.isApprover()},isSharer:function(){return 0!=(this.mode&P._SHARE)},isDeleter:function(){return 0!=(this.mode&P._DELETE)}};var q=function(e,t){this.name=e,this.created=null,this.updated=null,this.touched=null,this.acs=new P(null),this.private=null,this.public=null,this._users={},this._queuedSeqId=g,this._maxSeq=0,this._minSeq=0,this._noEarlierMsgs=!1,this._maxDel=0,this._tags=[],this._messages=function(e){var t=[];function n(t,n,s){for(var r=0,i=n.length-1,a=0,o=0,c=!1;r<=i;)if((o=e(n[a=(r+i)/2|0],t))<0)r=a+1;else{if(!(o>0)){c=!0;break}i=a-1}return c?a:s?-1:o<0?a+1:a}function s(e,t){var s=n(e,t,!1);return t.splice(s,0,e),t}return e=e||function(e,t){return e===t?0:e<t?-1:1},{getAt:function(e){return t[e]},put:function(){var e;for(var n in e=1==arguments.length&&Array.isArray(arguments[0])?arguments[0]:arguments)s(e[n],t)},delAt:function(e){var n=t.splice(e,1);if(n&&n.length>0)return n[0]},delRange:function(e,n){return t.splice(e,n-e)},size:function(){return t.length},reset:function(e){t=[]},forEach:function(e,n,s,r){n|=0,s=s||t.length;for(var i=n;i<s;i++)e.call(r,t[i],i)},find:function(e,s){return n(e,t,!s)}}}(function(e,t){return e.seq-t.seq}),this._subscribed=!1,this._lastDescUpdate=null,this._lastSubsUpdate=null,this._new=!0,t&&(this.onData=t.onData,this.onMeta=t.onMeta,this.onPres=t.onPres,this.onInfo=t.onInfo,this.onMetaDesc=t.onMetaDesc,this.onMetaSub=t.onMetaSub,this.onSubsUpdated=t.onSubsUpdated,this.onTagsUpdated=t.onTagsUpdated,this.onDeleteTopic=t.onDeleteTopic)};q.prototype={isSubscribed:function(){return this._subscribed},subscribe:function(e,t){if(this._subscribed)return Promise.resolve(this);var n=this.name,s=I.getInstance(),r=this;return s.subscribe(n||h,e,t).then(function(e){if(e.code>=300)return e;if(r._subscribed=!0,r.acs=e.params&&e.params.acs?e.params.acs:r.acs,r._new){r._new=!1,r.name=e.topic,r.created=e.ts,r.updated=e.ts,r.touched=e.ts,r._cachePutSelf();var n=s.getMeTopic();n&&n._processMetaSub([{_generated:!0,topic:r.name,created:e.ts,updated:e.ts,touched:e.ts,acs:r.acs}]),t&&t.desc&&(t.desc._generated=!0,r._processMetaDesc(t.desc))}return e})},publish:function(e){return this.publishMessage(this.createMessage(e))},createMessage:function(e,t){var n,s;return i.isPlainText(e)||(n=i.getContentType(),i.hasAttachments(e)&&(s=[],i.attachments(e,function(e){s.push(e)}))),I.getInstance().createMessage(this.name,e,t,n,s)},publishMessage:function(e){return this._subscribed?(e._sending=!0,I.getInstance().publishMessage(e)):Promise.reject(new Error("Cannot publish on inactive topic"))},publishDraft:function(e,t){var n=this;return t||this._subscribed?(e.seq=this._getQueuedSeqId(),e._generated=!0,e.ts=new Date,e.from=I.getInstance().getCurrentUserID(),e.noecho=!0,this._messages.put(e),this.onData&&this.onData(e),(t||Promise.resolve()).then(function(){return e._cancelled?{code:300,text:"cancelled"}:n.publishMessage(e).then(function(t){return e._sending=!1,e.seq=t.params.seq,e.ts=t.ts,n._routeData(e),t})},function(t){e._sending=!1,n._messages.delAt(n._messages.find(e)),n.onData&&n.onData()})):Promise.reject(new Error("Cannot publish on inactive topic"))},leave:function(e){var t=this;return this._subscribed||e?I.getInstance().leave(this.name,e).then(function(n){return t._resetSub(),e&&t._gone(),n}):Promise.reject(new Error("Cannot leave inactive topic"))},getMeta:function(e){return this._subscribed?I.getInstance().getMeta(this.name,e):(console.log("Attempt to query inactive topic",this.name),Promise.reject(new Error("Cannot query inactive topic")))},getMessagesPage:function(e,t){var n=this.startMetaQuery();t?n.withLaterData(e):n.withEarlierData(e);var s=this.getMeta(n.build());if(!t){var r=this;s=s.then(function(e){e&&e.params&&!e.params.count&&(r._noEarlierMsgs=!0)})}return s},setMeta:function(e){if(!this._subscribed)return Promise.reject(new Error("Cannot update inactive topic"));var t=this;e.tags&&(e.tags=function(e){var t=[];if(Array.isArray(e)){for(var n=0,s=e.length;n<s;n++){var r=e[n];r&&(r=r.trim().toLowerCase()).length>1&&t.push(r)}t.sort().filter(function(e,t,n){return!t||e!=n[t-1]})}return 0==t.length&&t.push("\u2421"),t}(e.tags));var n=I.getInstance();return n.setMeta(this.name,e).then(function(s){return s&&s.code>=300?s:(e.sub&&(s.params&&s.params.acs&&(e.sub.acs=s.params.acs,e.sub.updated=s.ts),e.sub.user||(e.sub.user=n.getCurrentUserID(),e.desc||(e.desc={})),e.sub._generated=!0,t._processMetaSub([e.sub])),e.desc&&(s.params&&s.params.acs&&(e.desc.acs=s.params.acs,e.desc.updated=s.ts),t._processMetaDesc(e.desc)),e.tags&&t._processMetaTags(e.tags),s)})},invite:function(e,t){return this.setMeta({sub:{user:e,mode:t}})},delMessages:function(e,t){var n=this;if(!this._subscribed)return Promise.reject(new Error("Cannot delete messages in inactive topic"));e.sort(function(e,t){return e.low<t.low||e.low==t.low&&(!t.hi||e.hi>=t.hi)});var s=e.reduce(function(e,t){return t.low<g&&(!t.hi||t.hi<g?e.push(t):e.push({low:t.low,hi:n._maxSeq+1})),e},[]);return(e.length>0?I.getInstance().delMessages(this.name,s,t):Promise.resolve({params:{del:0}})).then(function(t){return t.params.del>n._maxDel&&(n._maxDel=t.params.del),e.map(function(e){e.hi?n.flushMessageRange(e.low,e.hi):n.flushMessage(e.low)}),n.onData&&n.onData(),t})},delMessagesAll:function(e){return this.delMessages([{low:1,hi:this._maxSeq+1,_all:!0}],e)},delMessagesList:function(e,t){e.sort(function(e,t){return e-t});var n=e.reduce(function(e,t){if(0==e.length)e.push({low:t});else{var n=e[e.length-1];!n.hi&&t!=n.low+1||t>n.hi?e.push({low:t}):n.hi=n.hi?Math.max(n.hi,t+1):t+1}return e},[]);return this.delMessages(n,t)},delTopic:function(){var e=this;return I.getInstance().delTopic(this.name).then(function(t){return e._resetSub(),e._gone(),t})},delSubscription:function(e){if(!this._subscribed)return Promise.reject(new Error("Cannot delete subscription in inactive topic"));var t=this;return I.getInstance().delSubscription(this.name,e).then(function(n){return delete t._users[e],t.onSubsUpdated&&t.onSubsUpdated(Object.keys(t._users)),n})},note:function(e,t){var n=I.getInstance(),s=this._users[n.getCurrentUserID()];s?((!s[e]||s[e]<t)&&(this._subscribed?n.note(this.name,e,t):console.log("Not sending {note} on inactive topic")),s[e]=t):console.log("note(): user not found "+n.getCurrentUserID());var r=n.getMeTopic();r&&r.setMsgReadRecv(this.name,e,t)},noteRecv:function(e){this.note("recv",e)},noteRead:function(e){this.note("read",e)},noteKeyPress:function(){this._subscribed?I.getInstance().noteKeyPress(this.name):console.log("Cannot send notification in inactive topic")},userDesc:function(e){var t=this._cacheGetUser(e);if(t)return t},subscribers:function(e,t){var n=e||this.onMetaSub;if(n)for(var s in this._users)n.call(t,this._users[s],s,this._users)},tags:function(){return this._tags.slice(0)},subscriber:function(e){return this._users[e]},messages:function(e,t,n,s){var r=e||this.onData;if(r){var i="number"==typeof t?this._messages.find({seq:t}):void 0,a="number"==typeof n?this._messages.find({seq:n},!0):void 0;-1!=i&&-1!=a&&this._messages.forEach(r,i,a,s)}},msgReceiptCount:function(e,t){var n=0,s=I.getInstance().getCurrentUserID();if(t>0)for(var r in this._users){var i=this._users[r];i.user!==s&&i[e]>=t&&n++}return n},msgReadCount:function(e){return this.msgReceiptCount("read",e)},msgRecvCount:function(e){return this.msgReceiptCount("recv",e)},msgHasMoreMessages:function(e){return e?this.seq>this._maxSeq:this._minSeq>1&&!this._noEarlierMsgs},isNewMessage:function(e){return this._maxSeq<=e},flushMessage:function(e){var t=this._messages.find({seq:e});return t>=0?this._messages.delAt(t):void 0},flushMessageRange:function(e,t){var n=this._messages.find({seq:e});return n>=0?this._messages.delRange(n,this._messages.find({seq:t},!0)):[]},cancelSend:function(e){var t=this._messages.find({seq:e});if(t>=0){var n=this._messages.getAt(t);if(this.msgStatus(n)==m)return n._cancelled=!0,this._messages.delAt(t),!0}return!1},getType:function(){return I.getInstance().topicType(this.name)},getAccessMode:function(){return this.acs},getDefaultAccess:function(){return this.defacs},startMetaQuery:function(){return new O(this)},msgStatus:function(e){var t=v;return e.from==I.getInstance().getCurrentUserID()?e._sending?t=b:e.seq>=g?t=m:this.msgReadCount(e.seq)>0?t=M:this.msgRecvCount(e.seq)>0?t=w:e.seq>0&&(t=_):t=S,t},_routeData:function(e){e.content&&((!this.touched||this.touched<e.ts)&&(this.touched=e.ts),e._generated||this._messages.put(e)),e.seq>this._maxSeq&&(this._maxSeq=e.seq),(e.seq<this._minSeq||0==this._minSeq)&&(this._minSeq=e.seq),this.onData&&this.onData(e);var t=I.getInstance().getMeTopic();t&&t.setMsgReadRecv(this.name,"msg",e.seq,e.ts)},_routeMeta:function(e){e.desc&&(this._lastDescUpdate=e.ts,this._processMetaDesc(e.desc)),e.sub&&e.sub.length>0&&(this._lastSubsUpdate=e.ts,this._processMetaSub(e.sub)),e.del&&this._processDelMessages(e.del.clear,e.del.delseq),e.tags&&this._processMetaTags(e.tags),this.onMeta&&this.onMeta(e)},_routePres:function(e){var t;switch(e.what){case"del":this._processDelMessages(e.clear,e.delseq);break;case"on":case"off":(t=this._users[e.src])?t.online="on"==e.what:console.log("Presence update for an unknown user",this.name,e.src);break;case"acs":var n="me"==e.src?I.getInstance().getCurrentUserID():e.src;if(t=this._users[n])t.acs.updateAll(e.dacs),n==I.getInstance().getCurrentUserID()&&this.acs.updateAll(e.dacs),t.acs&&t.acs.mode!=P._NONE||("p2p"==this.getType()&&this.leave(),this._processMetaSub([{user:n,deleted:new Date,_generated:!0}]));else{var s=(new P).updateAll(e.dacs);s&&s.mode!=P._NONE&&((t=this._cacheGetUser(n))?t.acs=s:(t={user:n,acs:s},this.getMeta(this.startMetaQuery().withOneSub(void 0,n).build())),t._generated=!0,t.updated=new Date,this._processMetaSub([t]))}break;default:console.log("Ignored presence update",e.what)}this.onPres&&this.onPres(e)},_routeInfo:function(e){if("kp"!==e.what){var t=this._users[e.from];t&&(t[e.what]=e.seq)}this.onInfo&&this.onInfo(e)},_processMetaDesc:function(e,t){if(D(this,e),"string"==typeof this.created&&(this.created=new Date(this.created)),"string"==typeof this.updated&&(this.updated=new Date(this.updated)),"string"==typeof this.touched&&(this.touched=new Date(this.touched)),"me"!==this.name&&!t&&!e._generated){var n=I.getInstance().getMeTopic();n&&n._processMetaSub([{_generated:!0,topic:this.name,updated:this.updated,touched:this.touched,acs:this.acs,public:this.public,private:this.private}])}this.onMetaDesc&&this.onMetaDesc(this)},_processMetaSub:function(e){var t=void 0;for(var n in e){var s=e[n];if(s.user){s.updated=new Date(s.updated),s.deleted=s.deleted?new Date(s.deleted):null;var r=null;s.deleted?(delete this._users[s.user],r=s):((r=this._users[s.user])||(r=this._cacheGetUser(s.user)),r=this._updateCachedUser(s.user,s,s._generated)),this.onMetaSub&&this.onMetaSub(r)}else s._generated||(t=s)}t&&this.onMetaDesc&&this.onMetaDesc(t),this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._users))},_processMetaTags:function(e){1==e.length&&"\u2421"==e[0]&&(e=[]),this._tags=e,this.onTagsUpdated&&this.onTagsUpdated(e)},_processDelMessages:function(e,t){this._maxDel=Math.max(e,this._maxDel),this.clear=Math.max(e,this.clear);var n=this,s=0;Array.isArray(t)&&t.map(function(e){if(e.hi)for(var t=e.low;t<e.hi;t++)s++,n.flushMessage(t);else s++,n.flushMessage(e.low)}),s>0&&this.onData&&this.onData()},_resetSub:function(){this._subscribed=!1},_gone:function(){var e=I.getInstance().getMeTopic();e&&e._routePres({_generated:!0,what:"gone",topic:"me",src:this.name}),this.onDeleteTopic&&this.onDeleteTopic()},_updateCachedUser:function(e,t,n){var s=this._cacheGetUser(e);return s?s=D(s,t):(n&&this.getMeta(this.startMetaQuery().withLaterOneSub(e).build()),s=D({},t)),this._cachePutUser(e,s),T(this._users,e,s)},_getQueuedSeqId:function(){return this._queuedSeqId++}};var C=function(e){q.call(this,d,e),this._contacts={},e&&(this.onContactUpdate=e.onContactUpdate)};C.prototype=Object.create(q.prototype,{_processMetaSub:{value:function(e){var t=I.getInstance(),n=0;for(var s in e){var r=e[s],i=r.topic;if(i!==f){r.updated=new Date(r.updated),r.touched=r.touched?new Date(r.touched):null,r.deleted=r.deleted?new Date(r.deleted):null;var a=null;if(r.deleted)a=r,delete this._contacts[i];else if(r.seen&&r.seen.when&&(r.seen.when=new Date(r.seen.when)),a=T(this._contacts,i,r),"p2p"===t.topicType(i)&&this._cachePutUser(i,a),!r._generated){var o=t.getTopic(i);o&&o._processMetaDesc(r,!0)}n++,this.onMetaSub&&this.onMetaSub(a)}}n>0&&this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._contacts))},enumerable:!0,configurable:!0,writable:!1},_routePres:{value:function(e){var t=this._contacts[e.src];if(t){switch(e.what){case"on":t.online=!0;break;case"off":t.online&&(t.online=!1,t.seen?t.seen.when=new Date:t.seen={when:new Date});break;case"msg":t.touched=new Date,t.seq=e.seq;break;case"upd":this.getMeta(this.startMetaQuery().withLaterOneSub(e.src).build());break;case"acs":t.acs?t.acs.updateAll(e.dacs):t.acs=(new P).updateAll(e.dacs);break;case"ua":t.seen={when:new Date,ua:e.ua};break;case"recv":t.recv=t.recv?Math.max(t.recv,e.seq):e.seq;break;case"read":t.read=t.read?Math.max(t.read,e.seq):e.seq;break;case"gone":delete this._contacts[e.src]}this.onContactUpdate&&this.onContactUpdate(e.what,t)}else if("acs"==e.what){var n=new P(e.dacs);if(!n||n.mode==P._INVALID)return void console.log("Invalid access mode update",e.src,e.dacs);if(n.mode==P._NONE)return void console.log("Removing non-existent subscription",e.src,e.dacs);this.getMeta(this.startMetaQuery().withOneSub(void 0,e.src).build()),this._contacts[e.src]={topic:e.src,online:!1,acs:n}}this.onPres&&this.onPres(e)},enumerable:!0,configurable:!0,writable:!1},publish:{value:function(){return Promise.reject(new Error("Publishing to 'me' is not supported"))},enumerable:!0,configurable:!0,writable:!1},contacts:{value:function(e,t){var n=e||this.onMetaSub;if(n)for(var s in this._contacts)n.call(t,this._contacts[s],s,this._contacts)},enumerable:!0,configurable:!0,writable:!0},setMsgReadRecv:{value:function(e,t,n,s){var r,i=this._contacts[e],a=!1;i&&("recv"===t?(r=i.recv,i.recv=i.recv?Math.max(i.recv,n):n,a=r!=i.recv):"read"===t?(r=i.read,i.read=i.read?Math.max(i.read,n):n,a=r!=i.read,i.recv<i.read&&(i.recv=i.read,a=!0)):"msg"===t&&(r=i.seq,i.seq=i.seq?Math.max(i.seq,n):n,(!i.touched||i.touched<s)&&(i.touched=s),a=r!=i.seq),!a||i.acs&&i.acs.isMuted()||!this.onContactUpdate||this.onContactUpdate(t,i))},enumerable:!0,configurable:!0,writable:!0},getContact:{value:function(e){return this._contacts[e]},enumerable:!0,configurable:!0,writable:!0},unreadCount:{value:function(e){var t=this._contacts[e];return t?(t.seq=~~t.seq,t.read=~~t.read,t.seq-t.read):0},enumerable:!0,configurable:!0,writable:!0},getAccessMode:{value:function(e){var t=this._contacts[e];return t?t.acs:null},enumerable:!0,configurable:!0,writable:!0}}),C.prototype.constructor=C;var N=function(e){q.call(this,f,e),this._contacts={}};N.prototype=Object.create(q.prototype,{_processMetaSub:{value:function(e){I.getInstance();var t=Object.getOwnPropertyNames(this._contacts).length;for(var n in this._contacts={},e){var s=e[n],r=s.topic?s.topic:s.user;s.updated=new Date(s.updated),s.seen&&s.seen.when&&(s.seen.when=new Date(s.seen.when)),s=T(this._contacts,r,s),t++,this.onMetaSub&&this.onMetaSub(s)}t>0&&this.onSubsUpdated&&this.onSubsUpdated(Object.keys(this._contacts))},enumerable:!0,configurable:!0,writable:!1},publish:{value:function(){return Promise.reject(new Error("Publishing to 'fnd' is not supported"))},enumerable:!0,configurable:!0,writable:!1},setMeta:{value:function(e){var t=this;return Object.getPrototypeOf(N.prototype).setMeta.call(this,e).then(function(){Object.keys(t._contacts).length>0&&(t._contacts={},t.onSubsUpdated&&t.onSubsUpdated([]))})},enumerable:!0,configurable:!0,writable:!1},contacts:{value:function(e,t){var n=e||this.onMetaSub;if(n)for(var s in this._contacts)n.call(t,this._contacts[s],s,this._contacts)},enumerable:!0,configurable:!0,writable:!0}}),N.prototype.constructor=N;var k=function(e,t,n){this._apiKey=e,this._authToken=t,this._msgId=n,this.xhr=x(),this.toResolve=null,this.toReject=null,this.onProgress=null,this.onSuccess=null,this.onFailure=null};k.prototype={upload:function(e,t,n,s){var r=this,i=this;this.xhr.open("POST","/v"+c+"/file/u/",!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("Authorization","Token "+this._authToken);var a=new Promise(function(e,t){r.toResolve=e,r.toReject=t});this.onProgress=t,this.onSuccess=n,this.onFailure=s,this.xhr.upload.onprogress=function(e){e.lengthComputable&&i.onProgress&&i.onProgress(e.loaded/e.total)},this.xhr.onload=function(){var e;try{e=JSON.parse(this.response,E)}catch(e){console.log("Invalid server response in LargeFileHelper",this.response)}this.status>=200&&this.status<300?(i.toResolve&&i.toResolve(e.ctrl.params.url),i.onSuccess&&i.onSuccess(e.ctrl)):this.status>=400?(i.toReject&&i.toReject(new Error(e.ctrl.text+" ("+e.ctrl.code+")")),i.onFailure&&i.onFailure(e.ctrl)):console.log("Unexpected server response status",this.status,this.response)},this.xhr.onerror=function(e){i.toReject&&i.toReject(new Error("failed")),i.onFailure&&i.onFailure(null)},this.xhr.onabort=function(e){i.toReject&&i.toReject(new Error("upload cancelled by user")),i.onFailure&&i.onFailure(null)};try{var o=new FormData;o.append("file",e),o.set("id",this._msgId),this.xhr.send(o)}catch(e){this.toReject&&this.toReject(e),this.onFailure&&this.onFailure(null)}return a},download:function(e,t,n,s){var r=this;if(!/^(?:(?:[a-z]+:)?\/\/)/i.test(e)){var i=this;this.xhr.open("GET",e,!0),this.xhr.setRequestHeader("X-Tinode-APIKey",this._apiKey),this.xhr.setRequestHeader("Authorization","Token "+this._authToken),this.xhr.responseType="blob",this.onProgress=s,this.xhr.onprogress=function(e){i.onProgress&&i.onProgress(e.loaded)};var a=new Promise(function(e,t){r.toResolve=e,r.toReject=t});this.xhr.onload=function(){if(200==this.status){var e=document.createElement("a");e.href=window.URL.createObjectURL(new Blob([this.response],{type:n})),e.style.display="none",e.setAttribute("download",t),document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(e.href),i.toResolve&&i.toResolve()}else if(this.status>=400&&i.toReject){var s=new FileReader;s.onload=function(){try{var e=JSON.parse(this.result,E);i.toReject(new Error(e.ctrl.text+" ("+e.ctrl.code+")"))}catch(e){console.log("Invalid server response in LargeFileHelper",this.result),i.toReject(e)}},s.readAsText(this.response)}},this.xhr.onerror=function(e){i.toReject&&i.toReject(new Error("failed"))},this.xhr.onabort=function(){i.toReject&&i.toReject(null)};try{this.xhr.send()}catch(e){this.toReject&&this.toReject(e)}return a}console.log("The URL '"+e+"' must be relative, not absolute")},cancel:function(){this.xhr&&this.xhr.readyState<4&&this.xhr.abort()},getId:function(){return this._msgId}};var j=function e(t,n){this.status=e.STATUS_NONE,this.topic=t,this.content=n};return j.STATUS_NONE=v,j.STATUS_QUEUED=m,j.STATUS_SENDING=b,j.STATUS_SENT=_,j.STATUS_RECEIVED=w,j.STATUS_READ=M,j.STATUS_TO_ME=S,(j.prototype={toJSON:function(){},fromJSON:function(e){}}).constructor=j,(a=I.getInstance()).Drafty=i,a});